---
layout: article
title: rustç¼–è¯‘æ—¶æ³¨å…¥ç¼–è¯‘ä¿¡æ¯
tags: rust compile build
key: 2024-01-26-inject-build-info-while-compiling-with-rust
---

## èƒŒæ™¯

ä¸ç®¡æ˜¯ä»€ä¹ˆè¯­è¨€çš„æœåŠ¡ï¼Œç¼–è¯‘å‡ºæ¥çš„äºŒè¿›åˆ¶å¯èƒ½éƒ½æœ‰ä¸€ä¸ªæœ€ç®€å•çš„è¯‰æ±‚ï¼Œé‚£å°±æ˜¯å¯ä»¥å¿«é€Ÿçœ‹åˆ°è¿™ä¸ªäºŒè¿›åˆ¶çš„ä¸€äº›è¯¦ç»†ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼š

```shell
ğŸ‘‰ ./app-bin -v
# ä»å·¦åˆ°å³ä¸º: äºŒè¿›åˆ¶å, commit, OS/ARCH, rustcç‰ˆæœ¬, cargoç‰ˆæœ¬, ç¼–è¯‘æ—¶é—´
ğŸ‘‰ app-bin a78a4d3, linux/x86_64, compiled by rustc 1.74.1 (a28077b28 2023-12-04) and cargo 1.74.1 (ecb9851af 2023-10-18), built on 2024.01.26-07:47:09
```

è¿™ä¸ªå¯ä»¥å¸®æˆ‘ä»¬å¿«é€ŸæŒæ¡è¿™ä¸ªäºŒè¿›åˆ¶çš„ä¿¡æ¯ã€‚

## å®ç°

æˆ‘ä»¬å¯ä»¥é€šè¿‡rustè‡ªå¸¦çš„ç‰¹æ®Šæ–¹æ¡ˆï¼Œæ„å»º`build.rs`ï¼Œåœ¨ç¼–è¯‘æ—¶å°†æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯è®¾ç½®æˆ`cargo env`ä¼ é€’è¿›å»ã€‚

### ç›®å½•ç»“æ„

`build.rs`éœ€è¦åœ¨æ ¹ç›®å½•ä¸Š:

```shell
.
â”œâ”€â”€ build.rs
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ Makefile
â”œâ”€â”€ src
 Â Â  â”œâ”€â”€ main.rs
```

### ç¼–è¯‘é…ç½®

åœ¨`Cargo.toml`ä¸­éœ€è¦æŒ‡å®šbuildçš„æ–‡ä»¶:

```toml
[package]
name = "app-bin"
version = "0.1.0"
edition = "2021"
build = "build.rs"
```

### æ„é€ ç¯å¢ƒå˜é‡

```rust
// build.rs
use std::process::Command;

// æ‰§è¡Œå‘½ä»¤è¡Œå¾—åˆ°å¯¹åº”çš„ç»“æœ
fn execute_cmd(cmd: &str, args: &[&str], omit_error: bool) -> String {
    let output = match Command::new(cmd).args(args).output() {
        Ok(output) => output,
        Err(err) => {
            if omit_error {
                return "".to_string();
            } else {
                panic!("fail to execute command [{cmd}] because of [{err}]");
            }
        }
    };
    if !output.status.success() {
        if omit_error {
            return "".to_string();
        }
        panic!(
            "fail to execute command [{cmd}] because of [{}]",
            String::from_utf8_lossy(&output.stderr)
        );
    }
    String::from_utf8_lossy(&output.stdout).to_string()
}

// è®¾ç½®cargo env åœ¨ç¨‹åºä¸­å¯ä»¥è¢«ä½¿ç”¨åˆ°
fn set_cargo_env(name: &str, value: String) {
    // set cargo env only when it is not defined
    if std::env::var(name).is_err() {
        println!("cargo:rustc-env={name}={value}");
    }
    // rebuild is needed if this env is changed compared with last build
    println!("cargo:rerun-if-env-changed={name}");
}

fn main() {
    let build_date = execute_cmd("date", &["+%Y.%m.%d-%H:%M:%S"], false);
    // we should omit stderr in case git command is not installed
    let build_commit = execute_cmd("git", &["describe", "--always", "--long", "--dirty"], true);
    // we should omit stderr in case this repository has no any tags
    let build_tag = execute_cmd("git", &["describe", "--tags", "--abbrev=0"], true);
    let rustc_build_version = execute_cmd("rustc", &["--version"], false);
    let cargo_build_version = execute_cmd("cargo", &["--version"], false);

    set_cargo_env("BUILD_DATE", build_date);
    set_cargo_env("BUILD_COMMIT", build_commit);
    set_cargo_env("BUILD_TAG", build_tag);
    set_cargo_env("RUSTC_BUILD_VERSION", rustc_build_version);
    set_cargo_env("CARGO_BUILD_VERSION", cargo_build_version);
}
```

### ä¸»å‡½æ•°

```rust
use std::{env, process};

fn main() {
    let args: Vec<String> = env::args().collect();
    if args.len() > 1 && args[1].as_str() == "-v" {
        show_version();
    }
}

fn show_version() {
    // cargoç¼–è¯‘æ—¶è‡ªå¸¦çš„ç¯å¢ƒå˜é‡
    let name = env!("CARGO_PKG_NAME");
    // æˆ‘ä»¬è‡ªå·±æ·»åŠ è¿›æ¥çš„è¿è¡Œæ—¶ç¯å¢ƒå˜é‡
    let build_date = env!("BUILD_DATE");
    let git_tag = env!("BUILD_TAG");
    let git_commit = env!("BUILD_COMMIT");
    let rustc_build_version = env!("RUSTC_BUILD_VERSION");
    let cargo_build_version = env!("CARGO_BUILD_VERSION");

    let git_info = if git_tag.is_empty() {
        format!("{git_commit}")
    } else {
        format!("{git_tag}+{git_commit}")
    };

    let os = env::consts::OS;
    let arch = env::consts::ARCH;

    println!("{name} {git_info}, {os}/{arch}, compiled by {rustc_build_version} and {cargo_build_version}, built on {build_date}");

    process::exit(0);
}
```
