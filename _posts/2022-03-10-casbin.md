---
layout: article
title: Casbin
tags: Casbin authorization
key: 2022-03-03-Casbin
---


## ç®€ä»‹
ä¸€ä¸ªæ”¯æŒå¤šè¯­è¨€çš„æƒé™ç®¡ç†ã€è®¿é—®æ§åˆ¶åº“ã€‚æ”¯æŒå¤šç§æ§åˆ¶æ¨¡å‹:
- RBAC(Role Based Access Control)
- ACL(Access Control List)
- ABAC(Attribute Based Access Control)
- ...

 Tutorial: <https://casbin.org/docs/en/overview>

## æ¨¡å‹
casbinçš„æ¨¡å‹æ§åˆ¶æŠ½è±¡åˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­, ä¸»è¦åŒ…å«:
1. policy: æ§åˆ¶ç­–ç•¥/è§„åˆ™
2. request: è®¿é—®è¯·æ±‚, ä¸e.Enforce()çš„å‚æ•°ä¸€ä¸€å¯¹åº”
3. matcher: åŒ¹é…å™¨, ä¸å®šä¹‰çš„æ¯ä¸ªpolicyä¸€ä¸€åŒ¹é…ä¼šç”Ÿæˆå¤šä¸ªåŒ¹é…ç»“æœ
4. effect: æ ¹æ®åŒ¹é…ç»“æœå†³å®šè¯¥è¯·æ±‚æ˜¯å¦è·å¾—æˆæƒ


## ç¤ºä¾‹

```yaml
# requestçš„å®šä¹‰
# sub: å®ä½“(subject), dom: é¢†åŸŸ/ç§Ÿæˆ·(domain/tenant)
# obj: èµ„æº(objcet), act: è®¿é—®æ–¹æ³•(action)
[request_definition]
r = sub, dom, obj, act

# æ ¹æ®requestå¯¹ç…§çš„è§„åˆ™
[policy_definition]
p = sub, dom, obj, act

# è§„åˆ™çš„åˆ¶å®š å¯ç”¨äºç»§æ‰¿ ç¬¬ä¸‰ä¸ªå›ºå®šä¸ºdomain/tenant
[role_definition]
g = _,_,_

# æ ¹æ®å¤šä¸ªpolicyå¯¹requstè¿›è¡Œç­›é€‰å å¯¹æˆæƒæ˜¯å¦é€šè¿‡åˆ¤æ–­çš„ä¸€ä¸ªåŒ¹é…å™¨
[matchers]
m = g(r.sub, p.sub, r.dom) && r.dom == p.dom && r.obj == p.obj && r.act == p.obj
```


## ç‰¹æ€§
### ä¼˜å…ˆçº§(Priority Model)
1. æ˜ç¡®æŒ‡å®šä¼˜å…ˆçº§

```yaml
#model.conf
[policy_definition]
p = priority, sub, obj, act, eft

[role_definition]
g = _, _
```

```yaml
# policy.csv
# è™½ç„¶jackç»§æ‰¿äº†groupçš„è§„åˆ™ ä¸”groupæ˜¯æ²¡æœ‰readæƒé™
# ä½†æ˜¯jackè‡ªèº«æœ‰readæƒé™ä¸”priority=1æ¯”groupä¸­çš„è¦é«˜(è¶Šå°è¶Šé«˜) å› æ­¤jackæœ€ç»ˆå¯ä»¥read data
p, 2, group, data, read, deny
p, 1, jack, data, read, allow

g, jack, group
```

{:start="2"}
2. å±‚çº§ç»§æ‰¿ä¼˜å…ˆçº§(Hierarchy Priority)

```yaml
# policy.csv
# è¶Šåœ¨ç»§æ‰¿å±‚çº§ä¸Šå±‚çš„é»˜è®¤ä¼˜å…ˆçº§è¶Šé«˜ å› æ­¤jackæœ€ç»ˆå¯ä»¥read data
p, group, data, read, deny
p, jack, data, read, allow

g, jack, group
```


## æ€è€ƒğŸ¤”

åœ¨casbinæäº†å‡ ä¸ªissue, ä¸»è¦æ˜¯å›´ç»•åœ¨RBACçš„åšæ³•ä¸‹, å®ç°å…¨å±€ç­–ç•¥å¯¼è‡´çš„ä¸€äº›é—®é¢˜:

1. [å¦‚ä½•è®¾ç½®å…¨å±€ç­–ç•¥ï¼Œåªåœ¨è§’è‰²ç»§æ‰¿å’Œèµ‹äºˆé¢å¤–ç­–ç•¥æ—¶å†åŠ ä¸Šdomain](https://github.com/casbin/casbin/issues/968) (å·²è§£å†³)  
    æƒ³è¿™ä¹ˆåšä¸»è¦æ˜¯ä¸ºäº†å‡å°‘policyæ–‡ä»¶çš„è¡Œæ•°, å¹¶ä½¿policyæ–‡ä»¶ä¿æŒç®€æ´æ€§å’Œå¯é˜…è¯»æ€§  

2. [åœ¨RBACä½¿ç”¨pattern-matchingçš„æƒ…å†µä¸‹ï¼Œè·å–ç”¨æˆ·è¢«èµ‹äºˆå’Œç»§æ‰¿å¾—æ¥çš„æ‰€æœ‰ç­–ç•¥ä¸ç”Ÿæ•ˆ](https://github.com/casbin/casbin/issues/969) (å·²è§£å†³)  
    åœ¨ä¸Šä¸€æ¡ä½¿ç”¨pattern-matchingè§£å†³å, å‘ç°domainMatchingFuncå¹¶æ²¡æœ‰åœ¨è·å–ç­–ç•¥çš„è¿‡ç¨‹ä¸­è¢«ä½¿ç”¨ï¼Œå¯¼è‡´äº†è¿™ä¸ªé—®é¢˜çš„äº§ç”Ÿ  

3. [åœ¨LoadPolicyè¢«è°ƒç”¨æ—¶ä¼šå‘ç”Ÿåç¨‹é—´mapè¯»å†™å†²çª](https://github.com/casbin/casbin/issues/1116) (æœªè§£å†³)  
    å­˜æ”¾casbinæ¨¡å‹çš„mapä¼šå‡ºç°è¿­ä»£å™¨å’Œå†™çš„å†²çªï¼Œå¹³å¸¸ä¸æ€ä¹ˆè§¦å‘ï¼Œä½†æ˜¯ä¸€æ—¦å¯ç”¨äº†watcher(å…¶ä»–å®ä¾‹æ›´æ–°ï¼Œæœ¬å®ä¾‹ä¼šè°ƒç”¨LoadPolicy)ï¼Œpanicå‡ ç‡ä¸Šå‡