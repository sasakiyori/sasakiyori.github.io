---
layout: article
title: Golang Testing
tags: golang go test unit-test integration-test
key: 2022-03-03-Golang-Testing
---

## 测试覆盖率

1. 测试覆盖率

```shell
go test -cover
```

结果类似于:
```
PASS
coverage: 90% of statements
ok  	github.com/sasakiyori/test	1.025s
```

{:start="2"}
2. 区分unit test和integration test的覆盖率

参考: https://mickey.dev/posts/go-build-tags-testing/
unit test文件添加build tag
```go
// +build !integration

```

integration test文件添加build tag
```go
// +build integration

```

分别获取覆盖率:
```shell
# unit test
go test -cover
# integration test
go test --tags=integration -cover
```

{:start="3"}
3. 测试覆盖率可视化

参考: https://go.dev/blog/cover
```shell
# 将测试结果输出为本地文件
go test -coverprofile=result_file

# 将测试结果按go function区分展示
go tool cover -func=result_file

# 将测试结果按html展示
go tool cover -html=result_file

# 将测试结果保存为html文件
go tool cover -html=result_file -o coverage.html
```


## mock方法论
1. 在不使用其他plugin/package的前提下的mock方法论, 包含sql, file, http call等:
https://www.cbinsights.com/research/team-blog/mocking-techniques-for-go/
	- Higher-order functions: 使用封装函数, 将需要mock的函数作为封装函数的参数, 达到可替换的效果
	- Monkey patching: mock package级别的方法时, 将其赋予一个package级别的变量，再在mock时对变量进行替换
	- interface substitution: 想mock某个interface时, mock一个struct完全实现interface的方法进行替换
	- Embedding interfaces: 想mock某个interface里的部分函数时，可以将interface作为业务代码函数入参，使用内嵌的方式改写部分函数
	- Mocking out downstream HTTP calls with net/http/httptest

2. 好用的工具
   - [sql mock](https://github.com/DATA-DOG/go-sqlmock)
   - [http request mock](https://github.com/appleboy/gofight/v2)
   - [e2e test](https://github.com/gavv/httpexpect)